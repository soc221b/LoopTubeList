name: Pages CI

on:
  push:
    branches:
      - ${{ github.event.repository.default_branch }}

jobs:
  test:
    name: Run unit tests (test-first stub)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Install dependencies
        run: npm ci
      - name: Run unit tests (expected to fail initially)
        run: npm test

  build-and-validate:
    name: Build and validate
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v3
      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Install dependencies
        run: npm ci
      - name: Lint
        run: npm run lint --if-present || true
      - name: Build
        run: npm run build
      - name: Validate dist/index.html exists
        run: |
          if [ ! -f dist/index.html ]; then
            echo "dist/index.html missing" >&2
            exit 1
          fi
      - name: Generate deployment-record.json
        run: |
          mkdir -p artifacts
          python3 - <<'PY'
import json,os,sys,subprocess,datetime
sha = os.getenv('GITHUB_SHA','')
size = 0
if os.path.exists('dist'):
  for root,_,files in os.walk('dist'):
    for f in files:
      try:
        size += os.path.getsize(os.path.join(root,f))
      except Exception:
        pass
rec = {
  'commitSHA': sha,
  'timestamp': datetime.datetime.utcnow().isoformat()+'Z',
  'artifactSizeBytes': size,
  'status': 'success',
  'sourceBranch': os.getenv('GITHUB_REF','')
}
with open('artifacts/deployment-record.json','w') as fh:
  json.dump(rec,fh)
PY
      - name: Upload pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./dist

  deploy-pages:
    name: Deploy Pages
    runs-on: ubuntu-latest
    needs: build-and-validate
    steps:
      - name: Download artifact
        uses: actions/download-pages-artifact@v3
      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v1
      - name: Announce deployment in Actions summary
        uses: actions/github-script@v6
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const pagesUrl = `https://${owner}.github.io/${repo}`;
            core.summary.addRaw(`Deployed Pages site: ${pagesUrl}\nCommit: ${process.env.GITHUB_SHA}`).write();

  smoke-test:
    name: Smoke test deployed Pages
    runs-on: ubuntu-latest
    needs: deploy-pages
    steps:
      - uses: actions/checkout@v3
      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Install dependencies
        run: npm ci
      - name: Run smoke test (HTTP check)
        env:
          PAGES_URL: "https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}"
        run: |
          echo "Checking ${PAGES_URL}"
          status=$(curl -s -o /dev/null -w "%{http_code}" "${PAGES_URL}") || true
          echo "HTTP status: ${status}"
          if [ "${status}" != "200" ]; then
            echo "Smoke test failed: ${PAGES_URL} did not return 200" >&2
            exit 1
          fi

  notify-on-failure:
    name: Notify on failure
    runs-on: ubuntu-latest
    if: failure()
    steps:
      - uses: actions/github-script@v6
        with:
          script: |
            core.summary.addRaw(`Deployment validation failed for commit ${process.env.GITHUB_SHA}. See run: ${process.env.GITHUB_RUN_URL}`).write();
      - uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Pages deploy validation failed â€” run ${process.env.GITHUB_RUN_ID}`,
              body: `Validation failed for commit ${process.env.GITHUB_SHA}. See Actions run: ${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID}`
            })
